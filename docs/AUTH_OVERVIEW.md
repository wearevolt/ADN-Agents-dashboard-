# Авторизация в приложении (MVP)

Этот документ описывает, как сейчас устроена авторизация в приложении, какие есть файлы/эндпоинты, как их настраивать и отлаживать, и какие улучшения стоит сделать в будущих итерациях.

## Краткое описание

- **Источник авторизации**: основное приложение (общая доменная кука с JWT).
- **Тип проверки**: локальная верификация JWT на сервере (HS256 по `JWT_SECRET`), + (опционально) валидация активности пользователя через GraphQL `me` основного бекенда.
- **UI-поток**: экран логина проверяет текущую сессию через наш BFF `/api/auth/user`. Если сессии нет — предлагает кнопку «Sign In», которая ведёт на страницу логина основного приложения.

## Структура и ключевые файлы

- `src/middleware.ts`
  - Edge middleware (без криптографии):
    - Для `/api/*` при отсутствии куки — 401 JSON.
    - Для остальных страниц — пропускает рендер (экран логина сам решает, что делать).
- `src/app/api/auth/user/route.ts`
  - Наш BFF-эндпоинт `GET /api/auth/user`.
  - Делает верификацию JWT из HttpOnly-куки (см. ниже) и возвращает `{ id, email, active: true, roles: [], tenantId: null }`.
  - Если задан `MAIN_USERINFO_URL` — выполняет GraphQL запрос `query Me { me { id email } }` к основному бекенду с кукой пользователя. Если `me` нет → 403.
- `src/lib/auth/serverAuth.ts`
  - Локальная верификация JWT (`jsonwebtoken`) с `HS256`.
  - Нормализация пользователя: `id` = `sub` или `email` (из `user_data.email`) или `device_id`.
  - Отладочные логи включаются `AUTH_DEBUG=1`.
- `src/lib/auth/getCurrentUser.ts`
  - Утилита для RSC/SSR, возвращает `CurrentUser | null` на базе заголовков запроса.
- `src/lib/auth/withAuth.ts`
  - Guard-обёртка для API-роутов: централизованная проверка 401 и доступ к `user`.
- `src/components/LoginScreen.tsx`
  - Клиентский экран входа:
    - При монтировании опрашивает `/api/auth/user`. Если 200 — сразу «логинит» UI (берёт `email` и делает отображение имени).
    - Кнопка логина открывает `NEXT_PUBLIC_MAIN_AUTH_LOGIN_URL` (без `return_to` в MVP).
    - На время проверки/редиректа кнопка дизейблится и показывает спиннер.

## Переменные окружения

Минимальные (обязательные):

- `AUTH_COOKIE_NAME=auth_token` — имя доменной куки с JWT от основного приложения.
- `JWT_SECRET=...` — секрет для HS256.
- `MAIN_AUTH_LOGIN_URL=https://main.example.com/login` — URL логина основного приложения (используется на кнопке).

Опциональные (включаются по мере готовности):

- `NEXT_PUBLIC_MAIN_AUTH_LOGIN_URL=...` — клиентский аналог `MAIN_AUTH_LOGIN_URL` (для кнопки на фронте). Должен указывать на тот же URL.
- `MAIN_USERINFO_URL=https://main.example.com/graphql` — GraphQL endpoint для запроса `me`.
- `JWT_ISS=https://main.example.com` — строгая проверка issuer.
- `JWT_AUD=agents-app` — строгая проверка audience.
- `AUTH_DEBUG=1` — подробные логи в консоли сервера.
- (на будущее) `MAIN_AUTH_LOGOUT_URL`, `COOKIE_DOMAIN`, `INTROSPECTION_URL`, `SERVICE_TOKEN`, `AUTH_CACHE_TTL_MS`.

## Поведение по шагам

1. Браузер открывает приложение.
   - Если куки нет, `middleware` не редиректит — UI показывает экран логина.
2. Экран логина (клиент) вызывает `GET /api/auth/user`:
   - Если 200 — значит кука валидна (и, если настроен GraphQL `me`, пользователь существует) → UI пускает на основную страницу.
   - Если 401/403 — показываем кнопку «Sign In».
3. Кнопка «Sign In» открывает `NEXT_PUBLIC_MAIN_AUTH_LOGIN_URL`.
   - Авторизация происходит в основном приложении, где и выставляется общая кука.
4. После возврата в наше приложение `GET /api/auth/user` снова вернёт 200, UI пропустит дальше.

## Как отлаживать

- Включить логи: в `.env.local` добавить `AUTH_DEBUG=1` и перезапустить dev-сервер.
- Проверить токен:
  - Открыть `/api/auth/user` — в серверной консоли увидеть:
    - `cookie header`, `extracted token`, `decoded JWT payload`.
  - Если включён `MAIN_USERINFO_URL` — будут логи URL, тела запроса, статуса и JSON ответа GraphQL.
- Локальный запуск:
  - `yarn dev` стартует Next на `dev.agents.moneyball3.com:8080` (см. `package.json`).
  - Если домен не резолвится, добавить в `/etc/hosts`:
    ```
    127.0.0.1 dev.agents.moneyball3.com
    ```

## Безопасность и ограничения MVP

- Мы не выполняем server-side logout и CSRF-защиту (осознанно для MVP):
  - Logout: пока кнопка скрыта. План — редиректить на `MAIN_AUTH_LOGOUT_URL` и (опц.) очищать доменную куку локально.
  - CSRF: отложено. При появлении небезопасных методов (POST/PUT/PATCH/DELETE) необходимо добавить проверку Origin/Referer (и/или double-submit token).
- Без `MAIN_USERINFO_URL` пользователь, удалённый в основном бекенде, останется авторизован до истечения `exp` токена.
- Проверка ролей/прав сейчас не реализована (в токене их нет). Если потребуется — добавим валидацию через GraphQL/me или отдельный внутренний endpoint.

## Рекомендации по будущим улучшениям

1. Logout-поток:
   - Завести `GET /api/logout` → редирект на `MAIN_AUTH_LOGOUT_URL` + локальная очистка куки (`Domain=.example.com`).
2. CSRF-защита:
   - Включить guard на небезопасные методы (Origin/Referer) и при необходимости — double-submit token.
3. Строгие проверки JWT:
   - Подключить проверку `iss`, `aud` через `JWT_ISS`, `JWT_AUD`.
4. Интеграция с основным бекендом:
   - Оставить GraphQL `me` как базовую проверку существования пользователя.
   - (Опц.) Добавить отдельную интроспекцию статуса пользователя с коротким кэшем (если появится подходящий endpoint).
5. Наблюдаемость:
   - Метрики по 401/403, логи причин отказов, алёрты при всплесках отказов.
6. Роли/доступы:
   - Схема ролей и централизованный `withRole(...)` guard, если токен/GraphQL начнут отдавать роли.

## Быстрая проверка (Checklist)

- [x] Кука из основного приложения доступна нашему приложению.
- [x] `GET /api/auth/user` возвращает 200 с `{ id, email }` при валидной куке.
- [x] Экран логина автоматически пускает при валидной сессии; иначе — кнопка ведёт на логин основного приложения.
- [x] (Опц.) `MAIN_USERINFO_URL` настроен, и `me { id email }` подтверждает активность пользователя.
- [ ] (Позже) Logout через основной бекенд.
- [ ] (Позже) CSRF-guard для небезопасных методов.

## Связанные файлы для быстрого доступа

- `src/middleware.ts`
- `src/app/api/auth/user/route.ts`
- `src/lib/auth/serverAuth.ts`
- `src/lib/auth/getCurrentUser.ts`
- `src/lib/auth/withAuth.ts`
- `src/components/LoginScreen.tsx`
- `AUTH_PLAN.md` (дорожная карта и чек-листы)
